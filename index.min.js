import t from"axios";import e from"jschardet";import r from"node:url";function i(t,e,i){i=i.replace(":","");const c=/href="((.|\s)*?)"/i,n=/href='((.|\s)*?)'/i,o=t.match(/<link(.|\s)*?\/?>/gi);if(Array.isArray(o))for(const t of o){const o=t.toLowerCase();if(o.includes('rel="icon"')||o.includes("rel=icon")||o.includes("rel='icon'")||o.includes('rel="shortcut icon"')||o.includes("rel='shortcut icon'")||o.includes("rel='icon shortcut'")||o.includes('rel="icon shortcut"')||o.includes('rel="apple-touch-icon-precomposed"')||o.includes("rel='apple-touch-icon-precomposed'")||o.includes('rel="apple-touch-icon"')||o.includes("rel='apple-touch-icon'")){const o=t.match(c),s=t.match(n),a=o||s;if(a&&a[1]){let t=a[1];if(t.startsWith("data:image"))return t;if(t.startsWith("://"))return i+t;if(t.startsWith("//"))return i+":"+t;if(t.includes("://"))return t;if(t.startsWith("/"))return e+t;if(!t.startsWith("/"))return r.resolve(e,t);break}}}return""}async function c(r,c){const n={url:r,status:!0,errorMsg:"",iconUrl:"",title:"",description:""};if(!r)return n.status=!1,n.errorMsg="no url",n;try{const{origin:o,protocol:s}=new URL(r),a=await t.get(r,{headers:{"Accept-Language":"zh-CN,zh;q=0.9,en;q=0.8","Content-Type":"text/html;charset=utf-8"},responseType:"arraybuffer",...c}),l=Buffer.from(a.data,"binary"),u=e.detect(l).encoding||"utf-8";let f=new TextDecoder(u).decode(a.data);n.iconUrl=i(f,o,s).trim(),n.title=function(t){const e=t.match(/<title.*?>([^<]*)?<\/title>/i);return e&&e[1]||""}(f).trim(),n.description=function(t){let e="";const r=/content="((.|\s)*?)"/i,i=/content='((.|\s)*?)'/i,c=t.match(/<meta(.|\s)*?\/?>/gi);if(Array.isArray(c))for(const t of c){const c=t.toLowerCase();if(c.includes('name="description"')||c.includes("name=description")||c.includes("name='description'")){const c=t.match(r),n=t.match(i);if(c&&c[1]){e=c[1];break}if(n&&n[1]){e=n[1];break}}}return e}(f).trim();try{await t.get(n.iconUrl)}catch(e){try{const e=`${o}/favicon.ico`;await t.get(e),n.iconUrl=e}catch(t){}}}catch(t){n.errorMsg=t.message,n.status=!1}return n}export{c as default};
